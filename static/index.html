<!DOCTYPE html>
<html lang="zh">
  <head>
    <meta charset="UTF-8" />
    <title>高光谱数据集制作工具</title>
    <!-- 引入 Chart.js 用于绘制光谱曲线 -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
      /* 页面整体布局：左侧文件列表 + 右侧主工作区 */
      body {
        font-family: "Segoe UI", sans-serif;
        display: flex;
        height: 100vh;
        margin: 0;
        background: #f0f2f5;
      }

      /* 左侧侧边栏：固定宽度，包含文件列表 */
      #sidebar {
        width: 300px;
        background: #fff;
        border-right: 1px solid #ddd;
        padding: 10px;
        display: flex;
        flex-direction: column;
      }

      /* 文件列表区域：可滚动 */
      #file-list {
        overflow-y: auto;
        flex: 1;
      }

      /* 单个文件项样式 */
      .file-item {
        padding: 8px 12px;
        cursor: pointer;
        border-bottom: 1px solid #f0f0f0;
        font-size: 13px;
        word-break: break-all;
      }

      .file-item:hover {
        background: #e6f7ff;
      }

      .file-item.active {
        background: #1890ff;
        color: white;
      }

      /* 主工作区：包含图像预览和数据面板 */
      #main {
        flex: 1;
        display: flex;
        flex-direction: row;
        padding: 20px;
        gap: 20px;
      }

      /* 通用面板样式（卡片式） */
      .panel {
        background: #fff;
        padding: 20px;
        border-radius: 8px;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
      }

      /* 图像容器：居中显示，深色背景便于查看亮色图像 */
      #image-container {
        flex: 1;
        overflow: auto;
        display: flex;
        justify-content: center;
        align-items: start;
        background-color: #333;
      }

      /* 高光谱预览图：可点击，限制最大宽度 */
      #hsi-image {
        cursor: crosshair;
        max-width: 100%;
        display: block;
      }

      /* 右侧面板：固定宽度，包含光谱图和标注表单 */
      #data-panel {
        width: 400px;
        display: flex;
        flex-direction: column;
        gap: 15px;
      }

      /* 表单控件统一样式 */
      input,
      button {
        padding: 10px;
        width: 100%;
        box-sizing: border-box;
        margin-bottom: 10px;
      }

      button {
        background: #1890ff;
        color: white;
        border: none;
        cursor: pointer;
        font-weight: bold;
      }

      button:hover {
        background: #40a9ff;
      }

      /* 信息提示框 */
      #info-box {
        font-size: 14px;
        color: #666;
        background: #f9f9f9;
        padding: 10px;
      }
    </style>
  </head>
  <body>
    <!-- 左侧文件列表区域 -->
    <div id="sidebar">
      <h3>文件列表</h3>
      <div id="file-list">加载中...</div>
    </div>

    <!-- 主工作区 -->
    <div id="main">
      <!-- 高光谱图像预览 -->
      <div id="image-container" class="panel">
        <img id="hsi-image" src="" alt="请选择文件" style="display: none" />
      </div>

      <!-- 右侧数据与标注面板 -->
      <div id="data-panel" class="panel">
        <h3>光谱信息</h3>
        <div id="info-box">请点击图片上的点</div>
        <canvas id="spectrumChart"></canvas>

        <hr />
        <h3>标注保存</h3>
        <input
          type="text"
          id="label-input"
          placeholder="输入聚合物类别 (例如: pp，ps，pe...)"
        />
        <button onclick="saveData()">保存至数据集</button>
        <div id="status-msg" style="color: green"></div>
      </div>
    </div>

    <script>
      // ========== 全局状态变量 ==========
      let currentFile = ""; // 当前选中的高光谱文件路径
      let currentX = 0,
        currentY = 0; // 当前点击的像素坐标
      let currentSpectrum = []; // 当前光谱数据（强度值）
      let currentWavelengths = []; // 对应的波长值（用于保存和绘图）
      let chartInstance = null; // Chart.js 实例，用于更新光谱图

      // ========== 初始化：加载文件列表 ==========
      fetch("/api/files")
        .then((res) => res.json())
        .then((data) => {
          const list = document.getElementById("file-list");
          list.innerHTML = "";
          if (data.error) {
            list.innerHTML = `<div style="color:red">Error: ${data.error}</div>`;
            return;
          }
          // 动态生成文件项，并绑定点击事件
          data.files.forEach((filePath) => {
            const item = document.createElement("div");
            item.className = "file-item";
            item.innerText = filePath;
            item.onclick = () => loadFile(filePath, item);
            list.appendChild(item);
          });
        });

      // ========== 加载高光谱文件的预览图 ==========
      function loadFile(filePath, element) {
        currentFile = filePath;
        // 更新文件列表高亮状态
        document
          .querySelectorAll(".file-item")
          .forEach((e) => e.classList.remove("active"));
        element.classList.add("active");
        // 请求并显示伪彩色预览图
        const img = document.getElementById("hsi-image");
        img.src = `/api/image?filepath=${encodeURIComponent(filePath)}`;
        img.style.display = "block";
        img.onload = () => {
          const statusBox = document.getElementById("status-msg");
          statusBox.innerText = "图片已加载";
          setTimeout(() => {
            statusBox.innerText = "";
          }, 1000);
          // 清空之前的光谱图
          if (chartInstance) {
            chartInstance.data.datasets[0].data = [];
            chartInstance.update();
          }
        };
      }

      // ========== 图像点击事件：获取光谱 ==========
      document
        .getElementById("hsi-image")
        .addEventListener("click", function (e) {
          if (!currentFile) return;

          // 计算点击位置在原始图像中的真实坐标
          const rect = e.target.getBoundingClientRect();
          const scaleX = e.target.naturalWidth / e.target.width;
          const scaleY = e.target.naturalHeight / e.target.height;
          currentX = Math.floor((e.clientX - rect.left) * scaleX);
          currentY = Math.floor((e.clientY - rect.top) * scaleY);

          document.getElementById("info-box").innerText = `读取中...`;

          // 向后端请求该坐标的光谱数据
          fetch(
            `/api/spectrum?filepath=${encodeURIComponent(
              currentFile
            )}&x=${currentX}&y=${currentY}`
          )
            .then((res) => res.json())
            .then((data) => {
              currentSpectrum = data.spectrum;
              currentWavelengths = data.wavelengths;
              drawChart(data.wavelengths, data.spectrum);
              document.getElementById(
                "info-box"
              ).innerText = `选中: ${currentFile}\n坐标: ${currentX}, ${currentY}`;
            });
        });

      // ========== 绘制光谱曲线 ==========
      function drawChart(wavelengths, spectrum) {
        const ctx = document.getElementById("spectrumChart").getContext("2d");
        // 销毁旧图表（避免内存泄漏）
        if (chartInstance) chartInstance.destroy();
        chartInstance = new Chart(ctx, {
          type: "line",
          data: {
            labels: wavelengths, // X 轴：波长
            datasets: [
              {
                label: "光谱强度",
                data: spectrum, // Y 轴：强度值
                borderColor: "rgb(255, 99, 132)",
                borderWidth: 1,
                pointRadius: 0, // 不显示数据点，提升性能
                fill: false,
                tension: 0.1, // 平滑曲线
              },
            ],
          },
          options: {
            responsive: true,
            animation: false, // 关闭动画，提升交互响应速度
            scales: {
              x: { ticks: { maxTicksLimit: 6 } }, // 限制 X 轴标签数量
            },
          },
        });
      }

      // ========== 保存标注数据 ==========
      function saveData() {
        const label = document.getElementById("label-input").value.trim();
        const statusBox = document.getElementById("status-msg");

        // 输入校验
        if (!label) {
          alert("请输入标签名称！");
          return;
        }
        if (currentSpectrum.length === 0) {
          alert("请先选择一个点！");
          return;
        }

        // 构造标注数据（包含波长信息）
        const payload = {
          filename: currentFile,
          x: currentX,
          y: currentY,
          label: label,
          spectrum: currentSpectrum,
          wavelengths: currentWavelengths,
        };

        // 发送保存请求
        fetch("/api/save", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(payload),
        })
          .then((res) => res.json())
          .then((res) => {
            // 显示成功提示，2秒后自动清除
            statusBox.innerText = `保存成功: ${label}`;
            statusBox.style.color = "green";
            setTimeout(() => {
              statusBox.innerText = "";
            }, 1000);
          })
          .catch((err) => {
            // 显示失败提示，3秒后自动清除
            statusBox.innerText = "保存失败";
            statusBox.style.color = "red";
            setTimeout(() => {
              statusBox.innerText = "";
            }, 3000);
          });
      }
    </script>
  </body>
</html>
